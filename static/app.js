function $(id){return document.getElementById(id)};function toast(m){const t=$('toast');t.textContent=m;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),2500)};function confTier(p){return p>=0.8?'High':p>=0.6?'Medium':'Low'};function chipClass(l){return l==='admit'?'chip err':(l==='short_stay'?'chip warn':'chip ok')};
async function getSummary(){const pid=$('patientId').value;$('summarySkeleton').classList.remove('hidden');$('summaryBox').textContent='';try{const r=await fetch(`/patient/${pid}/summary`);const d=await r.json();$('summaryBox').textContent=d.summary||JSON.stringify(d,null,2);await loadVitalsChart(pid);await loadCalendar()}catch(e){toast('Failed to load summary')}finally{$('summarySkeleton').classList.add('hidden')}}
async function predictDisposition(e){e.preventDefault();const pid=$('patientId').value;const payload={patient_id:pid,visit_id:null,hr:+$('hr').value,rr:+$('rr').value,sbp:+$('sbp').value,temp:+$('temp').value,spo2:+$('spo2').value,triage_cat:+$('triage_cat').value,ecg_flag:+$('ecg_flag').value,lab_abn:+$('lab_abn').value,prev_ed_30d:+$('prev_ed_30d').value,arrival_mode:$('arrival_mode').value};$('spinPredict').classList.remove('hidden');try{const r=await fetch('/disposition/predict',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const d=await r.json();$('predictBox').textContent=JSON.stringify(d,null,2);$('chipLabel').className=chipClass(d.prediction);$('chipLabel').textContent=d.prediction.toUpperCase();$('chipConf').textContent=`Confidence: ${d.confidence} (${confTier(d.confidence)})`}catch(e){toast('Prediction failed')}finally{$('spinPredict').classList.add('hidden')}}
let vitalsChart;async function loadVitalsChart(pid){const r=await fetch(`/patient/${pid}/vitals`);const data=await r.json();const labels=data.map(d=>d.ts);const hr=data.map(d=>d.hr);const rr=data.map(d=>d.rr);const sbp=data.map(d=>d.sbp);const ctx=document.getElementById('vitalsChart').getContext('2d');if(vitalsChart) vitalsChart.destroy();vitalsChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'HR',data:hr,borderColor:'#22d3ee',tension:.3},{label:'RR',data:rr,borderColor:'#a78bfa',tension:.3},{label:'SBP',data:sbp,borderColor:'#f59e0b',tension:.3}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}})}
let calendar;async function loadCalendar(){if(calendar){calendar.destroy()}const el=document.getElementById('calendar');const r=await fetch('/calendar');const events=await r.json();calendar=new FullCalendar.Calendar(el,{initialView:'timeGridDay',nowIndicator:true,events});calendar.render()}
function copySummary(){const txt=$('summaryBox').textContent;navigator.clipboard.writeText(txt).then(()=>toast('Summary copied'))}
$('btnSummary').addEventListener('click',getSummary);$('btnCopy').addEventListener('click',copySummary);$('predictForm').addEventListener('submit',predictDisposition);
